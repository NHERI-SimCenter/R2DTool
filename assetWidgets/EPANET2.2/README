This code uses code from EPANET. 